<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Partidas Contables (NIIF - El Salvador)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f4f5f7;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
      border: none;
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
    }
    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge-soft {
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    .nav-pills .nav-link {
      border-radius: 999px;
      font-weight: 500;
    }
    .nav-pills .nav-link.active {
      background: #0f172a;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .table thead {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .btn-sm {
      border-radius: 999px;
      font-size: 0.75rem;
      padding-inline: 10px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .chip-activo {
      background: #dcfce7;
      color: #166534;
    }
    .chip-inactivo {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="app-header">
      <div class="app-title">
        üìò Sistema de Partidas Contables
        <span class="badge-soft">NIIF + enfoque tributario El Salvador</span>
      </div>
      <small class="text-muted">
        Doble partida (debe = haber). Cat√°logo amplio de cuentas con enfoque NIIF  
        y uso de cuentas t√≠picas de IVA/ISR salvadore√±as. Datos en <strong>localStorage</strong>.
      </small>
    </div>

    <!-- NAV -->
    <ul class="nav nav-pills mb-3" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-dashboard" type="button">
          Inicio / Resumen
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-catalogo" type="button">
          Cat√°logo de cuentas
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-partidas" type="button">
          Partidas contables
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- ========== DASHBOARD ========== -->
      <div class="tab-pane fade show active" id="tab-dashboard">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üìö Cat√°logo</div>
                <p class="mb-1"><small>Total cuentas</small></p>
                <div class="fs-4 fw-bold" id="dashTotalCuentas">0</div>
                <p class="mb-1 mt-2"><small>Cuentas activas</small></p>
                <div class="fs-6" id="dashCuentasActivas">0</div>
                <p class="mb-1 mt-2"><small>Cuentas inactivas</small></p>
                <div class="fs-6" id="dashCuentasInactivas">0</div>
                <p class="mt-2 text-muted" style="font-size:0.75rem;">
                  Se inicializa un plan de cuentas con ~1000 cuentas y subcuentas (muchas auxiliares), que puedes editar seg√∫n tu realidad.
                </p>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üßæ Partidas</div>
                <p class="mb-1">
                  Total de partidas registradas:
                  <strong id="dashTotalPartidas">0</strong>
                </p>
                <p class="mb-1">
                  Partidas del mes actual:
                  <strong id="dashPartidasMes">0</strong>
                </p>
                <p class="mb-0 text-muted">
                  <small>Recuerda: toda partida debe cumplir partida doble (NIIF / normativa contable salvadore√±a): Debe = Haber.</small>
                </p>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">‚öñÔ∏è Cuentas t√≠picas tributarias</div>
                <div class="section-subtitle">
                  Algunas cuentas clave ya incluidas:
                </div>
                <ul class="mb-0" style="font-size:0.8rem;">
                  <li>1101 Caja general</li>
                  <li>1102 Bancos</li>
                  <li>1105 Inventarios de mercader√≠as</li>
                  <li>1131 Cr√©dito fiscal IVA</li>
                  <li>2131 IVA por pagar / d√©bito fiscal</li>
                  <li>2132 ISR por pagar</li>
                  <li>2133 Pago a cuenta por pagar</li>
                  <li>4101 Ventas gravadas locales</li>
                  <li>5101 Costo de ventas</li>
                  <li>5102 Gastos administrativos</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== CAT√ÅLOGO ========== -->
      <div class="tab-pane fade" id="tab-catalogo">
        <div class="row g-3">
          <!-- FORM CUENTA -->
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üìö Cat√°logo de cuentas</div>
                <div class="section-subtitle">
                  Plan de cuentas con naturaleza NIIF: Activo, Pasivo, Patrimonio, Ingreso, Gasto, Cuentas de orden.
                </div>

                <form id="formCuenta">
                  <input type="hidden" id="ctaIndex" />
                  <div class="mb-2">
                    <label class="form-label">C√≥digo</label>
                    <input type="text" id="cta_codigo" class="form-control form-control-sm" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Nombre de la cuenta</label>
                    <input type="text" id="cta_nombre" class="form-control form-control-sm" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo NIIF</label>
                    <select id="cta_tipo" class="form-select form-select-sm">
                      <option value="Activo">Activo</option>
                      <option value="Pasivo">Pasivo</option>
                      <option value="Patrimonio">Patrimonio</option>
                      <option value="Ingreso">Ingreso</option>
                      <option value="Gasto">Gasto</option>
                      <option value="Orden">Cuenta de orden</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Descripci√≥n / Uso</label>
                    <textarea id="cta_descripcion" rows="2" class="form-control form-control-sm"></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select id="cta_estado" class="form-select form-select-sm">
                      <option value="Activa">Activa</option>
                      <option value="Inactiva">Inactiva</option>
                    </select>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-dark btn-sm flex-grow-1">Guardar</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFormCuenta()">
                      Nuevo
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- LISTADO CUENTAS -->
          <div class="col-lg-8">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üìã Listado de cuentas</div>
                <div class="section-subtitle">
                  Usa el filtro por tipo y el buscador para moverte entre las ~1000 cuentas iniciales.
                </div>

                <div class="row g-2 mb-2">
                  <div class="col-md-4">
                    <label class="form-label">Filtrar por tipo</label>
                    <select id="filtroTipoCuenta" class="form-select form-select-sm">
                      <option value="">Todos</option>
                      <option value="Activo">Activo</option>
                      <option value="Pasivo">Pasivo</option>
                      <option value="Patrimonio">Patrimonio</option>
                      <option value="Ingreso">Ingreso</option>
                      <option value="Gasto">Gasto</option>
                      <option value="Orden">Cuenta de orden</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Buscar (c√≥digo o nombre)</label>
                    <input
                      type="text"
                      id="filtroTextoCuenta"
                      class="form-control form-control-sm"
                      placeholder="Ej. 'Caja', '1101', 'Ventas'"
                    />
                  </div>
                </div>

                <div class="table-responsive" style="max-height:420px;">
                  <table class="table table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>C√≥digo</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="tablaCuentas"></tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== PARTIDAS ========== -->
      <div class="tab-pane fade" id="tab-partidas">
        <div class="row g-3">
          <!-- FORM PARTIDA -->
          <div class="col-lg-5">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üßæ Nueva partida contable</div>
                <div class="section-subtitle">
                  Debe estar cuadrada: la suma del <strong>Debe</strong> debe ser igual a la suma del <strong>Haber</strong>.
                  El sistema te avisa si la partida no cumple el principio de partida doble.
                </div>

                <form id="formPartida" onsubmit="guardarPartida(event)">
                  <div class="mb-2">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="par_fecha" class="form-control form-control-sm" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Descripci√≥n / Glosa</label>
                    <textarea id="par_glosa" rows="2" class="form-control form-control-sm" required></textarea>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo de operaci√≥n</label>
                    <select id="par_tipo" class="form-select form-select-sm">
                      <option value="General">General</option>
                      <option value="Venta gravada (IVA 13%)">Venta gravada (IVA 13%)</option>
                      <option value="Compra gravada (IVA 13%)">Compra gravada (IVA 13%)</option>
                      <option value="Gasto con IVA (administrativo)">Gasto con IVA (administrativo)</option>
                    </select>
                  </div>

                  <hr class="my-2">

                  <div class="mb-2">
                    <label class="form-label">L√≠neas de la partida</label>
                    <div class="section-subtitle mb-1">
                      Para usar una plantilla tributaria, indica el monto base (sin IVA) y aplica:
                    </div>
                    <div class="row g-2 mb-2">
                      <div class="col-7">
                        <input
                          type="number"
                          step="0.01"
                          id="par_montoBase"
                          class="form-control form-control-sm"
                          placeholder="Monto base sin IVA"
                        />
                      </div>
                      <div class="col-5 d-grid">
                        <button type="button" class="btn btn-outline-dark btn-sm" onclick="aplicarPlantilla()">
                          Aplicar plantilla
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="table-responsive" style="max-height:240px;">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>Cuenta (c√≥digo + nombre)</th>
                          <th>Detalle</th>
                          <th>Debe</th>
                          <th>Haber</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="tbodyLineas"></tbody>
                    </table>
                  </div>

                  <!-- datalist para todas las cuentas -->
                  <datalist id="listaCuentas"></datalist>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="agregarLinea()">
                      + Agregar l√≠nea
                    </button>
                    <div class="text-end" style="font-size:0.85rem;">
                      Debe: <strong>$<span id="sumDebe">0.00</span></strong> |
                      Haber: <strong>$<span id="sumHaber">0.00</span></strong>
                    </div>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-dark btn-sm flex-grow-1">
                      Guardar partida
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFormPartida()">
                      Nueva
                    </button>
                  </div>

                  <small class="text-muted d-block mt-2">
                    Plantillas incluidas:
                    <ul class="mb-0 ps-3">
                      <li>Venta gravada al contado: Caja/Bancos vs Ventas gravadas + IVA d√©bito.</li>
                      <li>Compra gravada al cr√©dito: Inventarios + Cr√©dito fiscal vs Proveedores.</li>
                      <li>Gasto administrativo con IVA: Gasto + Cr√©dito fiscal vs Caja/Bancos.</li>
                    </ul>
                  </small>
                </form>
              </div>
            </div>
          </div>

          <!-- LISTA PARTIDAS + DETALLE -->
          <div class="col-lg-7">
            <div class="card mb-3">
              <div class="card-body">
                <div class="section-title">üìë Partidas registradas</div>
                <div class="section-subtitle">
                  Selecciona una partida para ver el detalle.  
                  √ötil como borrador previo al registro en tu sistema contable formal.
                </div>

                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-hover align-middle mb-2">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Glosa</th>
                        <th>Total Debe</th>
                        <th>Total Haber</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="tablaPartidas"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <div class="section-title">üîé Detalle de partida seleccionada</div>
                <div class="section-subtitle">
                  Solo visualizaci√≥n. Si necesitas corregir, borra la partida y vuelve a registrarla.
                </div>

                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-sm align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Cuenta</th>
                        <th>Detalle</th>
                        <th>Debe</th>
                        <th>Haber</th>
                      </tr>
                    </thead>
                    <tbody id="tablaDetallePartida"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div> <!-- /col-7 -->
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======== VARIABLES GLOBALES ========
    let cuentas = [];
    let partidas = [];

    const TASA_IVA = 0.13;

    // ======== STORAGE ========
    function cargarDesdeStorage(clave) {
      try {
        const data = localStorage.getItem(clave);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.warn("Error leyendo", clave, e);
        return [];
      }
    }

    function guardarStorage() {
      localStorage.setItem("catalogoCuentas", JSON.stringify(cuentas));
      localStorage.setItem("partidasContables", JSON.stringify(partidas));
    }

    // ======== CATALOGO POR DEFECTO (‚âà1000 CUENTAS) ========
    function generarCatalogoPorDefecto() {
      const base = [
        // Activo corriente
        { codigo: "1101", nombre: "Caja general", tipo: "Activo", descripcion: "Efectivo disponible en caja", estado: "Activa" },
        { codigo: "1102", nombre: "Bancos cuenta corriente", tipo: "Activo", descripcion: "Cuentas bancarias de cheques", estado: "Activa" },
        { codigo: "1103", nombre: "Bancos cuenta de ahorro", tipo: "Activo", descripcion: "Cuentas de ahorro", estado: "Activa" },
        { codigo: "1104", nombre: "Caja chica", tipo: "Activo", descripcion: "Fondo fijo de caja chica", estado: "Activa" },
        { codigo: "1105", nombre: "Inventarios de mercader√≠as", tipo: "Activo", descripcion: "Mercader√≠as para la venta", estado: "Activa" },
        { codigo: "1106", nombre: "Inventarios de suministros", tipo: "Activo", descripcion: "Insumos y materiales", estado: "Activa" },
        { codigo: "1110", nombre: "Cuentas por cobrar clientes", tipo: "Activo", descripcion: "Cuentas por cobrar a clientes", estado: "Activa" },
        { codigo: "1111", nombre: "Documentos por cobrar", tipo: "Activo", descripcion: "Pagar√©s y otros documentos", estado: "Activa" },
        { codigo: "1112", nombre: "Cuentas por cobrar empleados", tipo: "Activo", descripcion: "Pr√©stamos a empleados", estado: "Activa" },
        { codigo: "1131", nombre: "Cr√©dito fiscal IVA", tipo: "Activo", descripcion: "IVA acreditable en compras", estado: "Activa" },
        { codigo: "1132", nombre: "Anticipos a proveedores", tipo: "Activo", descripcion: "Pagos anticipados", estado: "Activa" },
        // Activo no corriente
        { codigo: "1201", nombre: "Propiedades, planta y equipo - Terrenos", tipo: "Activo", descripcion: "Terrenos", estado: "Activa" },
        { codigo: "1202", nombre: "Propiedades, planta y equipo - Edificios", tipo: "Activo", descripcion: "Edificios", estado: "Activa" },
        { codigo: "1203", nombre: "Propiedades, planta y equipo - Maquinaria", tipo: "Activo", descripcion: "Maquinaria", estado: "Activa" },
        { codigo: "1204", nombre: "Propiedades, planta y equipo - Mobiliario y equipo", tipo: "Activo", descripcion: "Muebles y equipo de oficina", estado: "Activa" },
        { codigo: "1205", nombre: "Veh√≠culos", tipo: "Activo", descripcion: "Veh√≠culos de la entidad", estado: "Activa" },
        { codigo: "1210", nombre: "Depreciaci√≥n acumulada PPE", tipo: "Activo", descripcion: "Cuenta correctiva de PPE", estado: "Activa" },
        // Pasivos
        { codigo: "2101", nombre: "Proveedores", tipo: "Pasivo", descripcion: "Cuentas por pagar a proveedores", estado: "Activa" },
        { codigo: "2102", nombre: "Documentos por pagar", tipo: "Pasivo", descripcion: "Pr√©stamos documentados", estado: "Activa" },
        { codigo: "2103", nombre: "Cuentas por pagar diversas", tipo: "Pasivo", descripcion: "Otras cuentas por pagar", estado: "Activa" },
        { codigo: "2131", nombre: "IVA por pagar / d√©bito fiscal", tipo: "Pasivo", descripcion: "IVA trasladado en ventas", estado: "Activa" },
        { codigo: "2132", nombre: "ISR por pagar", tipo: "Pasivo", descripcion: "Impuesto sobre la renta por pagar", estado: "Activa" },
        { codigo: "2133", nombre: "Pago a cuenta por pagar", tipo: "Pasivo", descripcion: "Pago a cuenta pendiente de liquidar", estado: "Activa" },
        { codigo: "2134", nombre: "Retenciones por pagar", tipo: "Pasivo", descripcion: "ISR retenido a terceros", estado: "Activa" },
        { codigo: "2140", nombre: "Obligaciones laborales por pagar", tipo: "Pasivo", descripcion: "Sueldos, vacaciones, indemnizaciones", estado: "Activa" },
        // Patrimonio
        { codigo: "3101", nombre: "Capital social", tipo: "Patrimonio", descripcion: "Aportes de los propietarios", estado: "Activa" },
        { codigo: "3102", nombre: "Aportes adicionales de capital", tipo: "Patrimonio", descripcion: "Otros aportes de propietarios", estado: "Activa" },
        { codigo: "3201", nombre: "Resultados acumulados", tipo: "Patrimonio", descripcion: "Utilidades o p√©rdidas acumuladas", estado: "Activa" },
        { codigo: "3301", nombre: "Resultado del ejercicio", tipo: "Patrimonio", descripcion: "Utilidad o p√©rdida del periodo", estado: "Activa" },
        // Ingresos
        { codigo: "4101", nombre: "Ventas gravadas locales", tipo: "Ingreso", descripcion: "Ingresos por ventas gravadas", estado: "Activa" },
        { codigo: "4102", nombre: "Ventas exentas locales", tipo: "Ingreso", descripcion: "Ventas exentas de IVA", estado: "Activa" },
        { codigo: "4103", nombre: "Descuentos sobre ventas", tipo: "Ingreso", descripcion: "Descuentos concedidos (cuenta correctiva)", estado: "Activa" },
        { codigo: "4201", nombre: "Ingresos por servicios", tipo: "Ingreso", descripcion: "Honorarios y servicios prestados", estado: "Activa" },
        { codigo: "4301", nombre: "Ingresos financieros", tipo: "Ingreso", descripcion: "Intereses y rendimientos", estado: "Activa" },
        // Gastos
        { codigo: "5101", nombre: "Costo de ventas", tipo: "Gasto", descripcion: "Costo de las mercader√≠as vendidas", estado: "Activa" },
        { codigo: "5102", nombre: "Gastos administrativos", tipo: "Gasto", descripcion: "Gastos administrativos generales", estado: "Activa" },
        { codigo: "5103", nombre: "Gastos de venta", tipo: "Gasto", descripcion: "Gastos relacionados a la venta", estado: "Activa" },
        { codigo: "5104", nombre: "Gastos financieros", tipo: "Gasto", descripcion: "Intereses y comisiones", estado: "Activa" },
        { codigo: "5105", nombre: "Gasto por depreciaci√≥n", tipo: "Gasto", descripcion: "Depreciaci√≥n del periodo", estado: "Activa" },
        { codigo: "5106", nombre: "Gasto por arrendamientos", tipo: "Gasto", descripcion: "Alquileres de inmuebles y equipos", estado: "Activa" },
        // Cuentas de orden (ejemplo)
        { codigo: "6101", nombre: "Garant√≠as otorgadas", tipo: "Orden", descripcion: "Cuentas de orden deudoras", estado: "Activa" },
        { codigo: "6201", nombre: "Garant√≠as recibidas", tipo: "Orden", descripcion: "Cuentas de orden acreedoras", estado: "Activa" }
      ];

      // Generar cuentas auxiliares hasta llegar a ~1000
      const tipos = ["Activo", "Pasivo", "Patrimonio", "Ingreso", "Gasto", "Orden"];
      let correlativo = 1;
      let idxTipo = 0;
      // Empezamos en c√≥digo 7001 para auxiliares
      let codigoNum = 7001;

      while (base.length < 1000) {
        const tipo = tipos[idxTipo];
        const codigo = String(codigoNum).padStart(4, "0");
        base.push({
          codigo,
          nombre: `Cuenta auxiliar ${correlativo} (${tipo})`,
          tipo,
          descripcion: "Subcuenta auxiliar generada autom√°ticamente. Puedes renombrarla seg√∫n tu necesidad.",
          estado: "Activa"
        });
        correlativo++;
        codigoNum++;
        idxTipo = (idxTipo + 1) % tipos.length;
      }

      return base;
    }

    // ======== DASHBOARD ========
    function renderDashboard() {
      const totalCuentas = cuentas.length;
      const activas = cuentas.filter(c => c.estado === "Activa").length;
      const inactivas = totalCuentas - activas;

      document.getElementById("dashTotalCuentas").textContent = totalCuentas;
      document.getElementById("dashCuentasActivas").textContent = activas;
      document.getElementById("dashCuentasInactivas").textContent = inactivas;

      const totalPartidas = partidas.length;
      document.getElementById("dashTotalPartidas").textContent = totalPartidas;

      const hoy = new Date();
      const mesActual = hoy.getMonth() + 1;
      const anioActual = hoy.getFullYear();
      const partidasMes = partidas.filter(p => {
        const f = new Date(p.fecha + "T00:00:00");
        return f.getMonth() + 1 === mesActual && f.getFullYear() === anioActual;
      }).length;
      document.getElementById("dashPartidasMes").textContent = partidasMes;
    }

    // ======== CAT√ÅLOGO DE CUENTAS ========
    function resetFormCuenta() {
      const form = document.getElementById("formCuenta");
      form.reset();
      document.getElementById("ctaIndex").value = "";
      document.getElementById("cta_tipo").value = "Activo";
      document.getElementById("cta_estado").value = "Activa";
    }

    function renderDatalistCuentas() {
      const dl = document.getElementById("listaCuentas");
      if (!dl) return;
      dl.innerHTML = "";
      cuentas.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.codigo + " - " + c.nombre;
        dl.appendChild(opt);
      });
    }

    function renderCuentas() {
      const tbody = document.getElementById("tablaCuentas");
      tbody.innerHTML = "";

      const tipoFiltro = document.getElementById("filtroTipoCuenta").value;
      const textoFiltro = document.getElementById("filtroTextoCuenta").value.toLowerCase();

      const filtradas = cuentas.filter(c => {
        const coincideTipo = !tipoFiltro || c.tipo === tipoFiltro;
        const coincideTexto =
          !textoFiltro ||
          c.codigo.toLowerCase().includes(textoFiltro) ||
          c.nombre.toLowerCase().includes(textoFiltro);
        return coincideTipo && coincideTexto;
      });

      filtradas.forEach((c, idx) => {
        const estadoClass = c.estado === "Activa" ? "chip chip-activo" : "chip chip-inactivo";
        tbody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${c.codigo}</td>
            <td>${c.nombre}</td>
            <td>${c.tipo}</td>
            <td><span class="${estadoClass}">${c.estado}</span></td>
            <td class="text-end">
              <button class="btn btn-outline-dark btn-sm" onclick="editarCuenta('${c.codigo}')">Editar</button>
              <button class="btn btn-outline-danger btn-sm" onclick="eliminarCuenta('${c.codigo}')">Borrar</button>
            </td>
          </tr>
        `;
      });

      if (!filtradas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted">
              No hay cuentas que coincidan con el filtro actual.
            </td>
          </tr>
        `;
      }

      renderDatalistCuentas();
      renderDashboard();
    }

    function editarCuenta(codigo) {
      const c = cuentas.find(cta => cta.codigo === codigo);
      if (!c) return;
      document.getElementById("ctaIndex").value = codigo;
      document.getElementById("cta_codigo").value = c.codigo;
      document.getElementById("cta_nombre").value = c.nombre;
      document.getElementById("cta_tipo").value = c.tipo;
      document.getElementById("cta_descripcion").value = c.descripcion;
      document.getElementById("cta_estado").value = c.estado;
    }

    function eliminarCuenta(codigo) {
      if (!confirm("¬øSeguro que deseas eliminar esta cuenta del cat√°logo?")) return;
      cuentas = cuentas.filter(c => c.codigo !== codigo);
      guardarStorage();
      renderCuentas();
    }

    // ======== L√çNEAS DE PARTIDA ========
    function agregarLinea(cuenta = "", detalle = "", debe = "", haber = "") {
      const tbody = document.getElementById("tbodyLineas");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input type="text" class="form-control form-control-sm cuenta" list="listaCuentas"
                 placeholder="Ej. 1101 - Caja general" value="${cuenta}">
        </td>
        <td>
          <input type="text" class="form-control form-control-sm detalle" value="${detalle}">
        </td>
        <td>
          <input type="number" step="0.01" class="form-control form-control-sm debe" value="${debe}" oninput="recalcularSumas()">
        </td>
        <td>
          <input type="number" step="0.01" class="form-control form-control-sm haber" value="${haber}" oninput="recalcularSumas()">
        </td>
        <td class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove();recalcularSumas();">
            ‚úï
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      recalcularSumas();
    }

    function limpiarLineas() {
      document.getElementById("tbodyLineas").innerHTML = "";
      recalcularSumas();
    }

    function recalcularSumas() {
      let sumDebe = 0;
      let sumHaber = 0;
      document.querySelectorAll("#tbodyLineas tr").forEach(tr => {
        const d = parseFloat(tr.querySelector(".debe").value) || 0;
        const h = parseFloat(tr.querySelector(".haber").value) || 0;
        sumDebe += d;
        sumHaber += h;
      });
      document.getElementById("sumDebe").textContent = sumDebe.toFixed(2);
      document.getElementById("sumHaber").textContent = sumHaber.toFixed(2);
    }

    // ======== PLANTILLAS TRIBUTARIAS ========
    function aplicarPlantilla() {
      const tipo = document.getElementById("par_tipo").value;
      const montoBase = parseFloat(document.getElementById("par_montoBase").value) || 0;

      if (montoBase <= 0) {
        alert("Ingresa un monto base (sin IVA) mayor que cero para aplicar la plantilla.");
        return;
      }

      const iva = +(montoBase * TASA_IVA).toFixed(2);
      const total = +(montoBase + iva).toFixed(2);

      limpiarLineas();

      if (tipo === "Venta gravada (IVA 13%)") {
        agregarLinea("1101 - Caja general", "Cobro de venta gravada", total, 0);
        agregarLinea("4101 - Ventas gravadas locales", "Registro de ingreso por venta", 0, montoBase);
        agregarLinea("2131 - IVA por pagar / d√©bito fiscal", "IVA d√©bito por venta", 0, iva);
      } else if (tipo === "Compra gravada (IVA 13%)") {
        agregarLinea("1105 - Inventarios de mercader√≠as", "Compra gravada", montoBase, 0);
        agregarLinea("1131 - Cr√©dito fiscal IVA", "Cr√©dito fiscal por compra", iva, 0);
        agregarLinea("2101 - Proveedores", "Obligaci√≥n con proveedor", 0, total);
      } else if (tipo === "Gasto con IVA (administrativo)") {
        agregarLinea("5102 - Gastos administrativos", "Gasto administrativo", montoBase, 0);
        agregarLinea("1131 - Cr√©dito fiscal IVA", "Cr√©dito fiscal por gasto", iva, 0);
        agregarLinea("1102 - Bancos cuenta corriente", "Pago de gasto", 0, total);
      } else {
        alert("La plantilla 'General' no genera l√≠neas. Agr√©galas manualmente.");
      }
    }

    // ======== PARTIDAS ========
    function resetFormPartida() {
      const form = document.getElementById("formPartida");
      form.reset();
      document.getElementById("par_tipo").value = "General";
      document.getElementById("par_montoBase").value = "";
      limpiarLineas();
      agregarLinea();
      agregarLinea();
    }

    function guardarPartida(event) {
      event.preventDefault();

      const fecha = document.getElementById("par_fecha").value;
      const glosa = document.getElementById("par_glosa").value.trim();
      const tipo = document.getElementById("par_tipo").value;

      if (!fecha || !glosa) {
        alert("Completa la fecha y la glosa de la partida.");
        return;
      }

      const lineas = [];
      let sumDebe = 0;
      let sumHaber = 0;

      const filas = document.querySelectorAll("#tbodyLineas tr");
      for (const tr of filas) {
        const cuenta = tr.querySelector(".cuenta").value.trim();
        const detalle = tr.querySelector(".detalle").value.trim();
        const debe = parseFloat(tr.querySelector(".debe").value) || 0;
        const haber = parseFloat(tr.querySelector(".haber").value) || 0;

        if (!cuenta && debe === 0 && haber === 0) {
          continue; // l√≠nea vac√≠a
        }

        if (debe > 0 && haber > 0) {
          alert("Una l√≠nea no puede tener valores en Debe y Haber al mismo tiempo.");
          return;
        }

        lineas.push({ cuenta, detalle, debe, haber });
        sumDebe += debe;
        sumHaber += haber;
      }

      if (!lineas.length) {
        alert("Agrega al menos una l√≠nea con importe en Debe o Haber.");
        return;
      }

      if (sumDebe.toFixed(2) !== sumHaber.toFixed(2)) {
        alert("La partida no est√° cuadrada. Debe ($" + sumDebe.toFixed(2) + ") es diferente de Haber ($" + sumHaber.toFixed(2) + ").");
        return;
      }

      const partida = {
        id: Date.now(),
        fecha,
        glosa,
        tipo,
        totalDebe: sumDebe,
        totalHaber: sumHaber,
        lineas
      };

      partidas.push(partida);
      guardarStorage();
      renderPartidas();
      resetFormPartida();
    }

    function renderPartidas() {
      const tbody = document.getElementById("tablaPartidas");
      tbody.innerHTML = "";

      partidas.forEach((p, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${p.fecha}</td>
            <td>${p.tipo}</td>
            <td>${p.glosa}</td>
            <td>$${p.totalDebe.toFixed(2)}</td>
            <td>$${p.totalHaber.toFixed(2)}</td>
            <td class="text-end">
              <button class="btn btn-outline-dark btn-sm" onclick="verPartida(${i})">Ver</button>
              <button class="btn btn-outline-danger btn-sm" onclick="eliminarPartida(${i})">Borrar</button>
            </td>
          </tr>
        `;
      });

      if (!partidas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">
              A√∫n no hay partidas registradas.
            </td>
          </tr>
        `;
      }

      renderDashboard();
    }

    function verPartida(index) {
      const p = partidas[index];
      const tbody = document.getElementById("tablaDetallePartida");
      tbody.innerHTML = "";

      p.lineas.forEach(l => {
        tbody.innerHTML += `
          <tr>
            <td>${l.cuenta}</td>
            <td>${l.detalle}</td>
            <td>$${(l.debe || 0).toFixed(2)}</td>
            <td>$${(l.haber || 0).toFixed(2)}</td>
          </tr>
        `;
      });

      if (!p.lineas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted">
              Sin l√≠neas para mostrar.
            </td>
          </tr>
        `;
      }
    }

    function eliminarPartida(index) {
      if (!confirm("¬øSeguro que deseas eliminar esta partida contable?")) return;
      partidas.splice(index, 1);
      guardarStorage();
      renderPartidas();
      if (!partidas.length) {
        document.getElementById("tablaDetallePartida").innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted">
              Sin partida seleccionada.
            </td>
          </tr>
        `;
      }
    }

    // ======== INIT ========
    window.addEventListener("DOMContentLoaded", () => {
      cuentas = cargarDesdeStorage("catalogoCuentas");
      partidas = cargarDesdeStorage("partidasContables");

      // Si no hay cuentas, o hay muy pocas, generamos el cat√°logo base + auxiliares
      if (!cuentas.length) {
        cuentas = generarCatalogoPorDefecto();
      } else if (cuentas.length < 1000) {
        // Complementar hasta llegar a ~1000 manteniendo las existentes
        const existentes = cuentas.slice();
        const generadas = generarCatalogoPorDefecto();
        // Evitar duplicar c√≥digos existentes
        const codigosExist = new Set(existentes.map(c => c.codigo));
        generadas.forEach(c => {
          if (!codigosExist.has(c.codigo)) {
            existentes.push(c);
          }
        });
        cuentas = existentes.slice(0, 1000);
      }

      // Formulario cuentas
      const formCuenta = document.getElementById("formCuenta");
      formCuenta.addEventListener("submit", e => {
        e.preventDefault();
        const idxCodigo = document.getElementById("ctaIndex").value;

        const cuenta = {
          codigo: document.getElementById("cta_codigo").value.trim(),
          nombre: document.getElementById("cta_nombre").value.trim(),
          tipo: document.getElementById("cta_tipo").value,
          descripcion: document.getElementById("cta_descripcion").value.trim(),
          estado: document.getElementById("cta_estado").value
        };

        if (!cuenta.codigo || !cuenta.nombre) {
          alert("Ingresa el c√≥digo y el nombre de la cuenta.");
          return;
        }

        const existenteIndex = cuentas.findIndex(c => c.codigo === idxCodigo || c.codigo === cuenta.codigo);

        if (existenteIndex >= 0) {
          cuentas[existenteIndex] = cuenta;
        } else {
          cuentas.push(cuenta);
        }

        guardarStorage();
        renderCuentas();
        resetFormCuenta();
      });

      // Filtros cat√°logo
      document.getElementById("filtroTipoCuenta").addEventListener("change", renderCuentas);
      document.getElementById("filtroTextoCuenta").addEventListener("input", renderCuentas);

      // Render inicial
      renderCuentas();
      renderPartidas();

      // Detalle vac√≠o
      document.getElementById("tablaDetallePartida").innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-muted">
            Sin partida seleccionada.
          </td>
        </tr>
      `;

      // Preparar formulario de partida
      resetFormPartida();
    });
  </script>
</body>
</html>
